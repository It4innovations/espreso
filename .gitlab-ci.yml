
stages:
  - DUMMY
  - INTEL_32
  - INTEL_64
  - FOSS_32
  - FOSS_64
  - FOSS_MKL_32
  - FOSS_MKL_64

.ws:
  when: always
  tags:
    - ws
  script:
    - ./waf configure
    - ./waf -j8

# ----------------------------------------------------------------------------------------------- #
#                        DUMMY INSTALATION WITHOUT ANY THIRD-PARTY LIBRARY                        #
# ----------------------------------------------------------------------------------------------- #

D4W_INSTALL:
  extends: .ws
  stage: DUMMY
  cache:
    key: deps-dummy-32
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.foss.32.sh
  script:
    - ./waf configure --skip-suitesparse --skip-mkl --skip-blas --skip-lapack
    - ./waf -j8

D8W_INSTALL:
  extends: .ws
  stage: DUMMY
  cache:
    key: deps-dummy-64
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.foss.64.sh
  script:
    - ./waf configure --skip-suitesparse --skip-mkl --skip-blas --skip-lapack
    - ./waf -j8

# ----------------------------------------------------------------------------------------------- #
#                                     INTEL MPI + INTEL MKL                                       #
# ----------------------------------------------------------------------------------------------- #

I4W_INSTALL:
  extends: .ws
  stage: INTEL_32
  cache:
    key: deps-intel-32
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.intel.32.sh

I4W_BASIC:
  extends: I4W_INSTALL
  needs: ["I4W_INSTALL"]
  script:
    - sh tests/run.basic.sh

I4W_ASSEMBLER:
  extends: I4W_INSTALL
  needs: ["I4W_INSTALL"]
  script:
    - sh tests/run.assembler.sh

I4W_PHYSICS:
  extends: I4W_INSTALL
  needs: ["I4W_INSTALL"]
  script:
    - sh tests/run.physical_solver.sh

I4W_FETI:
  extends: I4W_INSTALL
  needs: ["I4W_INSTALL"]
  script:
    - sh tests/run.feti.sh

I8W_INSTALL:
  extends: .ws
  stage: INTEL_64
  cache:
    key: deps-intel-64
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.intel.64.sh

I8W_BASIC:
  extends: I8W_INSTALL
  needs: ["I8W_INSTALL"]
  script:
    - sh tests/run.basic.sh

I8W_ASSEMBLER:
  extends: I8W_INSTALL
  needs: ["I8W_INSTALL"]
  script:
    - sh tests/run.assembler.sh

I8W_PHYSICS:
  extends: I8W_INSTALL
  needs: ["I8W_INSTALL"]
  script:
    - sh tests/run.physical_solver.sh

I8W_FETI:
  extends: I8W_INSTALL
  needs: ["I8W_INSTALL"]
  script:
    - sh tests/run.feti.sh

# ----------------------------------------------------------------------------------------------- #
#                                    OPEN MPI + SUITESPARSE                                       #
# ----------------------------------------------------------------------------------------------- #

F4W_INSTALL:
  extends: .ws
  stage: FOSS_32
  cache:
    key: deps-foss-32
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.foss.32.sh

F4W_BASIC:
  extends: F4W_INSTALL
  needs: ["F4W_INSTALL"]
  script:
    - sh tests/run.basic.sh

F4W_ASSEMBLER:
  extends: F4W_INSTALL
  needs: ["F4W_INSTALL"]
  script:
    - sh tests/run.assembler.sh

F4W_PHYSICS:
  extends: F4W_INSTALL
  needs: ["F4W_INSTALL"]
  script:
    - sh tests/run.physical_solver.sh

F4W_FETI:
  extends: F4W_INSTALL
  needs: ["F4W_INSTALL"]
  script:
    - sh tests/run.feti.sh

F8W_INSTALL:
  extends: .ws
  stage: FOSS_64
  cache:
    key: deps-foss-64
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.foss.64.sh

F8W_BASIC:
  extends: F8W_INSTALL
  needs: ["F8W_INSTALL"]
  script:
    - sh tests/run.basic.sh

F8W_ASSEMBLER:
  extends: F8W_INSTALL
  needs: ["F8W_INSTALL"]
  script:
    - sh tests/run.assembler.sh

F8W_PHYSICS:
  extends: F8W_INSTALL
  needs: ["F8W_INSTALL"]
  script:
    - sh tests/run.physical_solver.sh

F8W_FETI:
  extends: F8W_INSTALL
  needs: ["F8W_INSTALL"]
  script:
    - sh tests/run.feti.sh

# ----------------------------------------------------------------------------------------------- #
#                                         OPEN MPI + MKL                                          #
# ----------------------------------------------------------------------------------------------- #

M4W_INSTALL:
  extends: .ws
  stage: FOSS_MKL_32
  cache:
    key: deps-foss-mkl-32
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.foss.mkl.32.sh

M4W_BASIC:
  extends: M4W_INSTALL
  needs: ["M4W_INSTALL"]
  script:
    - sh tests/run.basic.sh

M4W_ASSEMBLER:
  extends: M4W_INSTALL
  needs: ["M4W_INSTALL"]
  script:
    - sh tests/run.assembler.sh

M4W_PHYSICS:
  extends: M4W_INSTALL
  needs: ["M4W_INSTALL"]
  script:
    - sh tests/run.physical_solver.sh

M4W_FETI:
  extends: M4W_INSTALL
  needs: ["M4W_INSTALL"]
  script:
    - sh tests/run.feti.sh

M8W_INSTALL:
  extends: .ws
  stage: FOSS_MKL_64
  cache:
    key: deps-foss-mkl-64
    paths:
      - dependencies
      - build
  before_script:
    - . env/workstation.foss.mkl.64.sh

M8W_BASIC:
  extends: M8W_INSTALL
  needs: ["M8W_INSTALL"]
  script:
    - sh tests/run.basic.sh

M8W_ASSEMBLER:
  extends: M8W_INSTALL
  needs: ["M8W_INSTALL"]
  script:
    - sh tests/run.assembler.sh

M8W_PHYSICS:
  extends: M8W_INSTALL
  needs: ["M8W_INSTALL"]
  script:
    - sh tests/run.physical_solver.sh

M8W_FETI:
  extends: M8W_INSTALL
  needs: ["M8W_INSTALL"]
  script:
    - sh tests/run.feti.sh



